
<?php $this->load->view('web/common/header.html');?>
<link rel="stylesheet" type="text/css" href="/static/css/jquery.slider.css?v=<?=$v?>">

<div class="floor_descr">
    <div class="wrap">
        <div class="descr">
            <h2>报告定制需求表单</h2>
            <h3>
                围绕传统产业转型和战略性新兴产业发展，面向战略决策，提供政策与技术发展态势监测、市场分析与投资咨询、前沿技术趋势预见等服务，为用户在市场拓展、技术引进、技术研发决策提供帮助。提供三类情报调研服务：产业细分领域前沿技术研究；产业细分领域市场分析；产业细分领域态势监测。</h3>
            <div class="btn_link"><a href="/report/more_reports">更多报告&gt;&gt;</a></div>
        </div>
    </div>
</div>

<div class="floor_form">
    <div class="wrap clearfix">
        <div class="left_form">
            <?php if(isset($main_conn)) :?>
            <input type="hidden" id="exists_main_conn" value="1">
            <div class="row_group">
                <div class="client clearfix" data-id="<?php echo  $main_conn['id'] ?>">
                    <h2>主要联系人</h2>
                    <span class="name"><?php echo  $main_conn["username"] ?></span>
                    <span class="edit_contact" data-id="<?php echo  $main_conn['id'] ?>" style="margin-right:85px;">修改</span>
                </div>
            </div>

            <?php else :?>

            <div class="group_wrap">
                <h2>主要联系人</h2>
                <div class="group_content">
                    <div class="row_group clearfix">
                        <div class="col_group">
                            <div class="title"><h3>姓名</h3></div>
                            <div class="input"><input id="main_conn_name" type="text" placeholder="请输入姓名"></div>
                        </div>
                        <div class="col_group" style="margin-right: 0px;">
                            <div class="title"><h3>邮箱</h3></div>
                            <div class="input"><input id="main_conn_email" type="text" placeholder="请输入邮箱"></div>
                        </div>
                    </div>
                    <div class="row_group clearfix">
                        <div class="col_group">
                            <div class="title"><h3>单位</h3></div>
                            <div class="input"><input id="main_conn_company" type="text" placeholder="请输入单位名称"></div>
                        </div>
                        <div class="col_group" style="margin-right: 0px;">
                            <div class="title"><h3>手机</h3></div>
                            <div class="input"><input id="main_conn_phone" type="text" placeholder="请输入手机号码"></div>
                        </div>
                    </div>
                </div>
            </div>
            <?php endif ;?>

            <?php if(isset($other_conn)) :?>
            <?php foreach($other_conn as $c):?>
            <div class="row_group">
                <div class="client clearfix" data-id="<?php echo  $c['id'] ?>">
                    <h2>其他联系人</h2>
                    <span class="name"><?php echo  $c["username"] ?></span>
                    <span class="del_contact" data-id="<?php echo  $c['id'] ?>">删除</span>
                    <span class="edit_contact" data-id="<?php echo  $c['id'] ?>">修改</span>
                </div>
            </div>
            <?php endforeach ;?>
            <?php endif ;?>

            <div class="row_group"><p id="add_contact" class="add_contact">+添加其他联系人</p></div>

            <div class="group_wrap">
                <h2>报告需求</h2>
                <div class="group_content">
                    <input type="hidden" id="random_code" value="<?php echo $random_code ?>">
                    <div class="row_group clearfix">
                        <div class="col_group">
                            <div class="title"><h3>研究领域</h3></div>
                            <div class="input">
                                <select class="box_sizing" id="domain">
                                    <option value="0">请选择研究领域</option>
                                    <?php foreach($domain as $d):?>
                                    <option value="<?php echo $d ?>"><?php echo $d ?></option>
                                    <?php endforeach ;?>
                                </select>
                            </div>
                        </div>
                        <div class="col_group" style="margin-right: 0px;">
                            <div class="title"><h3>分析主题</h3></div>
                            <div class="input"><input type="text" id="subject" placeholder="请填写报告分析主题"></div>
                        </div>
                    </div>
                    <div class="row_group clearfix">
                        <div class="col_group">
                            <div class="title"><h3>技术关键词</h3></div>
                            <div class="input"><input type="text" id="keyword" placeholder="请填写技术关键词"></div>
                        </div>
                        <div class="col_group" style="margin-right: 0px;">
                            <div class="title"><h3>分析目的</h3></div>
                            <div class="input"><input type="text" id="purpose" placeholder="请输入分析目的"></div>
                        </div>
                    </div>
                    <div class="row_group clearfix">
                        <div class="col_group" style="width: 640px; margin-right: 0px;">
                            <div class="title"><h3>拟解决的关键问题</h3></div>
                            <div class="input">
                                <div class="textarea">
                                    <textarea id="solution" placeholder="请填写报告希望解决哪些方面的问题"></textarea>
                                    <div class="enclo">
                                        <ul id="enclo_list" class="enclo_list"></ul>
                                        <div style="margin-top:10px;">
                                            <div id="enclo_upload" class="enclo_upload">+点此上传附件</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row_group">
                <div id="move_bar"></div>
            </div>

            <div class="row_group" style="padding-top: 50px;">
                <button type="button" id="submit_form" class="submit_form">提交</button>
            </div>

        </div>
        <div class="right_process">
            <h2>报告定制流程</h2>
            <ul class="process_list">
                <li>提出需求</li>
                <li>我们根据需求提供报告框架并报价</li>
                <li>沟通确定报告最终目录、价格及完成时间</li>
                <li>签订服务委托合同</li>
                <li>撰写报告</li>
                <li>沟通修改</li>
                <li>提交报告终版</li>
            </ul>
        </div>
    </div>
</div>

<!-- 添加模态框 -->
<div id="add_module" class="snail_module" data-status="hide">
    <div class="snail_module_panel">
        <div class="snail_module_head"><h2>添加联系人</h2><span class="close">&times;</span></div>
        <div class="snail_module_body">
            <div class="snail_module_row">
                <label>姓名</label>
                <div class="snail_module_input"><input type="text" id="add_name"></div>
            </div>
            <div class="snail_module_row">
                <label>单位</label>
                <div class="snail_module_input"><input type="text" id="add_company"></div>
            </div>
            <div class="snail_module_row">
                <label>邮箱</label>
                <div class="snail_module_input"><input type="text" id="add_email"></div>
            </div>
            <div class="snail_module_row">
                <label>手机</label>
                <div class="snail_module_input"><input type="text" id="add_phone"></div>
            </div>
        </div>
        <div class="snail_module_foot">
            <button type="button" id="submit_add_module">提交</button>
        </div>
    </div>
</div>

<!-- 添加模态框 -->
<div id="update_module" class="snail_module" data-status="hide">
    <div class="snail_module_panel">
        <div class="snail_module_head"><h2>修改联系人</h2><span class="close">&times;</span></div>
        <input type="hidden" id="update_user_id">
        <div class="snail_module_body">
            <div class="snail_module_row">
                <label>姓名</label>
                <div class="snail_module_input"><input type="text" id="update_name"></div>
            </div>
            <div class="snail_module_row">
                <label>单位</label>
                <div class="snail_module_input"><input type="text" id="update_company"></div>
            </div>
            <div class="snail_module_row">
                <label>邮箱</label>
                <div class="snail_module_input"><input type="text" id="update_email"></div>
            </div>
            <div class="snail_module_row">
                <label>手机</label>
                <div class="snail_module_input"><input type="text" id="update_phone"></div>
            </div>
        </div>
        <div class="snail_module_foot">
            <button type="button" id="submit_update_module">提交</button>
        </div>
    </div>
</div>

<?php $this->load->view('web/common/footer.html');?>

<script type="text/javascript" src="/static/js/jquery.slider.min.js"></script>
<script type="text/javascript" src="/static/admin/Plugins/plupload-2.1.2/js/plupload.full.min.js"></script>
<script type="text/javascript" src="/static/js/plupload.js?v=<?=$v?>"></script>
<script type="text/javascript">
    var move_slider = false;
    // 添加联系人
    $('#add_contact').click(function () {
        $('#add_module').attr('data-status', 'show');
    });
    //添加其他联系人,提交
    $('#submit_add_module').click(function () {
        var name = $.trim($('#add_name').val()), company = $.trim($('#add_company').val()),
            email = $.trim($('#add_email').val()), phone = $.trim($('#add_phone').val());
        if (!name || !company || !email || !phone) {
            tips('信息要填写完整');
            return;
        }
        $.ajax({
            type: 'post',
            url: '/user/add_connect_user',
            data: {
                username: name,
                company: company,
                email: email,
                phone: phone,
                is_main: 0
            },
            dataType: 'json',
            success: function (res) {
                if (res['status'] == -1) {
                    tips(res['error']);
                } else {
                    var htmlStr = '<div class="row_group"><div class="client clearfix" data-id="' + res['user']['id'] + '">';
                    htmlStr += '<h2>其他联系人</h2><span class="name">' + name + '</span>';
                    htmlStr += '<span class="del_contact" data-id="' + res['user']['id'] + '">删除</span>';
                    htmlStr += '<span class="edit_contact" data-id="' + res['user']['id'] + '">修改</span></div></div>';
                    $('#add_contact').parent().before(htmlStr);
                    $('.snail_module').find('.close').trigger('click');
                }
            },
            error: function () {

            }
        });
    });
    //修改其他联系人,提交
    $('#submit_update_module').click(function () {
        var name = $.trim($('#update_name').val()), company = $.trim($('#update_company').val()),
                email = $.trim($('#update_email').val()), id = $.trim($('#update_user_id').val()),
                phone = $.trim($('#update_phone').val());
        if (!name || !company || !email || !phone || !id) {
            tips('信息要填写完整');
            return;
        }
        $.ajax({
            type: 'post',
            url: '/user/update_connect_user',
            data: {
                username: name,
                company: company,
                email: email,
                phone: phone,
                id: id
            },
            dataType: 'json',
            success: function (res) {
                if (res['status'] == -1) {
                    tips(res['error']);
                }
                if (res['status'] == 1) {
                    $('.client[data-id="' + res['user']['id'] + '"]').find('.name').html(res['user']['username'])
                    $('.snail_module').find('.close').trigger('click');
                }
            },
            error: function () {

            }
        });
    });
    // 点击修改联系人按钮
    $('body').on('click', '.edit_contact', function () {
        var id = $(this).attr('data-id');
        if (id) {
            $.ajax({
                type: 'post',
                url: "/user/get_connect_user",
                data: {
                    id: id
                },
                dataType: 'json',
                success: function (data) {
                    if (data['status'] == -1) {
                        tips(data['error']);
                    }
                    if (data['status'] == 1) {
                        $('#update_name').val(data['user']['username']);
                        $('#update_phone').val(data['user']['phone']);
                        $('#update_email').val(data['user']['email']);
                        $('#update_company').val(data['user']['company']);
                        $('#update_user_id').val(id);
                        $('#update_module').attr('data-status', 'show');
                    }
                }
            });
        }
    });
    // 删除联系人
    $('body').on('click', '.del_contact', function () {
        var oThis = $(this), id = oThis.attr('data-id');
        if (id) {
            $.ajax({
                type: 'post',
                url: "/user/del_connect_user",
                data: {
                    id: id
                },
                dataType: 'json',
                success: function (data) {
                    if (data['status'] == -1) {
                        tips(data['error']);
                    }
                    if (data['status'] == 1) {
                        oThis.closest('.row_group').remove();
                    }
                }
            });
        }
    });
    // 上传附件
    plupFile('customReport', 'enclo_upload', '10mb', 'enclo_list');
    $('#enclo_list').on('click', 'span', function () {
        $(this).closest('li').remove();
    });
    // 拖动滑块
    $("#move_bar").slider({
        width: 340, // width
        height: 40, // height
        sliderBg: "rgb(134, 134, 131)", // 滑块背景颜色
        color: "#fff", // 文字颜色
        fontSize: 14, // 文字大小
        bgColor: "#33CC00", // 背景颜色
        textMsg: "按住滑块，拖拽验证", // 提示文字
        successMsg: "验证通过了哦", // 验证成功提示文字
        successColor: "#fff", // 滑块验证成功提示文字颜色
        time: 400, // 返回时间
        callback: function (result) { // 回调函数，true(成功),false(失败)
            if (result) {
                move_slider = true;
            }
        }
    });
    // 提交表单
    $("#submit_form").click(function () {
        if(!move_slider){
            tips("请拖动滑块验证");
            return;
        }
        var existsMainConn = $('#exists_main_conn').val();
        if (existsMainConn == 1) {
            addReport();
        } else {
            var username = $.trim($('#main_conn_name').val());
            var phone = $.trim($('#main_conn_phone').val());
            var email = $.trim($('#main_conn_email').val());
            var company = $.trim($('#main_conn_company').val());
            if (!username || !phone || !email || !company) {
                tips("请填写主要联系人信息");
                return;
            }
            $.ajax({
                type: 'post',
                url: "/user/add_connect_user",
                data: {
                    'username': username,
                    'phone': phone,
                    'email': email,
                    'company': company,
                    'is_main': 1
                },
                dataType: 'json',
                success: function (data) {
                    if (data['status'] == -1) {
                        tips(data['error']);
                    }
                    if (data['status'] == 1) {
                        addReport();
                    }
                }
            });
        }
    });
    //添加定制报告
    function addReport() {
        var domain = $('#domain').val();
        var subject = $('#subject').val();
        var keyword = $('#keyword').val();
        var purpose = $('#purpose').val();
        var solution = $('#solution').val();
        var random_code = $('#random_code').val();
        var attachment_id = [];
        $('#enclo_list').children('li').each(function () {
            var id = $(this).attr('data-id');
            attachment_id.push(id);
        })
        if (!domain || !subject || !keyword || !purpose || !solution) {
            tips("请填写完整报告需求");
            return;
        }
        $.ajax({
            type: 'post',
            url: "/report/add_custom_report",
            data: {
                domain: domain,
                subject: subject,
                keyword: keyword,
                purpose: purpose,
                solution: solution,
                attachment: attachment_id,
                random_code:random_code
            },
            dataType: 'json',
            success: function (data) {
                if (data['status'] == -1) {
                    tips(data['error']);
                }
                if (data['status'] == 1) {
                    tips2();
                }
            }
        });
    }
</script>
