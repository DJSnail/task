
<?php $this->load->view('web/common/header.html');?>
<link rel="stylesheet" type="text/css" href="/static/css/jquery.slider.css?v=<?=$v?>">

<div class="floor_descr">
    <div class="wrap">
        <div class="descr">
            <h2>文献传递</h2>
            <h3>
                依托国家科技图书文献中心（National Science and Technology library, 简称NSTL）与中国科学院文献情报中心，为国内科研用户提供中国科学院文献情报中心等NSTL所属理、工、医、农、化工、机械、标准9家国家级图书馆馆藏文献的用于科研和学习目的的少量全文传递服务及国内、国际代查和代传递服务。</h3>
            <div class="btn_link"><a target="_blank">查看我的申请&gt;&gt;</a></div>
        </div>
    </div>
</div>

<div class="floor_form">
    <div class="wrap clearfix">
        <div class="left_form">
            <?php if(isset($main_conn)) :?>
            <input type="hidden" id="exists_main_conn" value="1">
            <div class="row_group">
                <div class="client clearfix" data-id="<?php echo  $main_conn['id'] ?>">
                    <h2>主要联系人</h2>
                    <span class="name"><?php echo  $main_conn["username"] ?></span>
                    <span class="edit_contact" data-id="<?php echo  $main_conn['id'] ?>" style="margin-right:85px;">修改</span>
                </div>
            </div>
            
            <?php else :?>

            <div class="group_wrap">
                <h2>主要联系人</h2>
                <div class="group_content">
                    <div class="row_group clearfix">
                        <div class="col_group">
                            <div class="title"><h3>姓名</h3></div>
                            <div class="input"><input id="main_conn_name" type="text" placeholder="请输入姓名"></div>
                        </div>
                        <div class="col_group" style="margin-right: 0px;">
                            <div class="title"><h3>邮箱</h3></div>
                            <div class="input"><input id="main_conn_email" type="text" placeholder="请输入邮箱"></div>
                        </div>
                    </div>
                    <div class="row_group clearfix">
                        <div class="col_group">
                            <div class="title"><h3>单位</h3></div>
                            <div class="input"><input id="main_conn_company" type="text" placeholder="请输入单位名称"></div>
                        </div>
                        <div class="col_group" style="margin-right: 0px;">
                            <div class="title"><h3>手机</h3></div>
                            <div class="input"><input id="main_conn_phone" type="text" placeholder="请输入手机号码"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <?php endif ;?>
            
            <?php if(isset($other_conn)) :?>
            <?php foreach($other_conn as $c):?>
            <div class="row_group">
                <div class="client clearfix" data-id="<?php echo  $c['id'] ?>">
                    <h2>其他联系人</h2>
                    <span class="name"><?php echo  $c["username"] ?></span>
                    <span class="del_contact" data-id="<?php echo  $c['id'] ?>">删除</span>
                    <span class="edit_contact" data-id="<?php echo  $c['id'] ?>">修改</span>
                </div>
            </div>
            <?php endforeach ;?>
            <?php endif ;?>

            <div class="row_group"><p id="add_contact" class="add_contact">+添加其他联系人</p></div>

            <div class="group_wrap">
                <h2>文献信息</h2>
                <div class="group_content">
                    <input type="hidden" id="random_code" value="<?php echo $random_code ?>">
                    <div class="row_group clearfix">
                        <div class="col_group">
                            <div class="title"><h3 class="free">书刊名称</h3></div>
                            <div class="input"><input type="text" id="doc_name" placeholder="请填写书刊名称"></div>
                        </div>
                        <div class="col_group" style="margin-right: 0px;">
                            <div class="title"><h3>文章标题</h3></div>
                            <div class="input"><input type="text" id="doc_title" placeholder="请填写文章标题"></div>
                        </div>
                    </div>
                    <div class="row_group clearfix">
                        <div class="col_group">
                            <div class="title"><h3>文章作者</h3></div>
                            <div class="input"><input type="text" id="doc_author" placeholder="请填写文章作者"></div>
                        </div>
                        <div class="col_group" style="margin-right: 0px;">
                            <div class="title"><h3 class="free">出版年 ( 数字 )</h3></div>
                            <div class="input"><input type="text" id="doc_time" placeholder="请填写出版年"></div>
                        </div>
                    </div>
                    <div class="row_group clearfix">
                        <div class="col_group">
                            <div class="title"><h3 class="free">卷期 ( 数字 )</h3></div>
                            <div class="input"><input type="text" id="doc_vol" placeholder="请填写卷期"></div>
                        </div>
                        <div class="col_group" style="margin-right: 0px;">
                            <div class="title"><h3 class="free">起止页码 ( 数字-数字 )</h3></div>
                            <div class="input"><input type="text" id="doc_page" placeholder="例如 30-100"></div>
                        </div>
                    </div>
                    <div class="row_group clearfix">
                        <div class="col_group" style="width: 640px; margin-right: 0px;">
                            <div class="title"><h3 class="free">备注</h3></div>
                            <div class="input">
                                <div class="textarea">
                                    <textarea id="doc_note" placeholder="请填写备注"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row_group">
                <div class="protocol clearfix">
                    <input type="checkbox" id="protocol">
                    <a href="javascript:;" target="_blank">同意《文献传递合理使用》用户承诺书</a>
                </div>
            </div>

            <div class="row_group">
                <div id="move_bar"></div>
            </div>

            <div class="row_group" style="padding-top: 50px;">
                <button type="button" id="submit_form" class="submit_form">提交</button>
            </div>

        </div>
        <div class="right_standard">
            <h2>服务标准</h2>
            <ul class="standard_list">
                <li>
                    <h3>普通文献</h3>
                    <p>服务费用：2元 / 篇</p>
                    <p>复制费用：0.3元 / 页</p>
                    <p>版权费用：5-10元 / 篇</p>
                </li>
                <li>
                    <h3>专利文献</h3>
                    <p>服务费用：2元 / 篇</p>
                    <p>复制费用：5元 / 篇</p>
                </li>
                <li>
                    <h3>其他说明</h3>
                    <p>服务时间：2个工作日</p>
                    <p>加急费用：10元 / 篇</p>
                    <p>外文文献收取版权费；版权费收取标准：外文期刊、外文会议文献、外文文集汇编：5元/篇；外文学位论文和国外科技报告：10元/篇。</p>
                    <p>NSTL机构外获取文献及国际代查收费标准，视实际情况而定；</p>
                </li>
            </ul>
        </div>
    </div>
</div>

<!-- 添加模态框 -->
<div id="add_module" class="snail_module" data-status="hide">
    <div class="snail_module_panel">
        <div class="snail_module_head"><h2>其他联系人</h2><span class="close">&times;</span></div>
        <div class="snail_module_body">
            <div class="snail_module_row">
                <label>姓名</label>
                <div class="snail_module_input"><input type="text" id="add_name"></div>
            </div>
            <div class="snail_module_row">
                <label>单位</label>
                <div class="snail_module_input"><input type="text" id="add_company"></div>
            </div>
            <div class="snail_module_row">
                <label>邮箱</label>
                <div class="snail_module_input"><input type="text" id="add_email"></div>
            </div>
            <div class="snail_module_row">
                <label>手机</label>
                <div class="snail_module_input"><input type="text" id="add_phone"></div>
            </div>
        </div>
        <div class="snail_module_foot">
            <button type="button" id="submit_add_module">提交</button>
        </div>
    </div>
</div>

<!-- 添加模态框 -->
<div id="update_module" class="snail_module" data-status="hide">
    <div class="snail_module_panel">
        <div class="snail_module_head"><h2>其他联系人</h2><span class="close">&times;</span></div>
        <input type="hidden" id="update_user_id">
        <div class="snail_module_body">
            <div class="snail_module_row">
                <label>姓名</label>
                <div class="snail_module_input"><input type="text" id="update_name"></div>
            </div>
            <div class="snail_module_row">
                <label>单位</label>
                <div class="snail_module_input"><input type="text" id="update_company"></div>
            </div>
            <div class="snail_module_row">
                <label>邮箱</label>
                <div class="snail_module_input"><input type="text" id="update_email"></div>
            </div>
            <div class="snail_module_row">
                <label>手机</label>
                <div class="snail_module_input"><input type="text" id="update_phone"></div>
            </div>
        </div>
        <div class="snail_module_foot">
            <button type="button" id="submit_update_module">提交</button>
        </div>
    </div>
</div>

<?php $this->load->view('web/common/footer.html');?>

<script type="text/javascript" src="/static/js/jquery.slider.min.js" ></script>
<script type="text/javascript">
    var move_slider = false;
    // 添加联系人
    $('#add_contact').click(function () {
        $('#add_module').attr('data-status', 'show');
    });
    //添加其他联系人,提交
    $('#submit_add_module').click(function () {
        var name = $.trim($('#add_name').val()), company = $.trim($('#add_company').val()),
            email = $.trim($('#add_email').val()), phone = $.trim($('#add_phone').val());
        if (!name || !company || !email || !phone) {
            tips('信息要填写完整');
            return;
        }
        $.ajax({
            type: 'post',
            url: '/user/add_connect_user',
            data: {
                username: name,
                company: company,
                email: email,
                phone: phone,
                is_main: 0
            },
            dataType: 'json',
            success: function (res) {
                if (res['status'] == -1) {
                    tips(res['error']);
                } else {
                    var htmlStr = '<div class="row_group"><div class="client clearfix" data-id="' + res['user']['id'] + '">';
                    htmlStr += '<h2>其他联系人</h2><span class="name">' + name + '</span>';
                    htmlStr += '<span class="del_contact" data-id="' + res['user']['id'] + '">删除</span>';
                    htmlStr += '<span class="edit_contact" data-id="' + res['user']['id'] + '">修改</span></div></div>';
                    $('#add_contact').parent().before(htmlStr);
                    $('.snail_module').find('.close').trigger('click');
                }
            },
            error: function () {

            }
        });
    });
    //修改其他联系人,提交
    $('#submit_update_module').click(function () {
        var name = $.trim($('#update_name').val()), company = $.trim($('#update_company').val()),
                email = $.trim($('#update_email').val()), id = $.trim($('#update_user_id').val()),
                phone = $.trim($('#update_phone').val());
        if (!name || !company || !email || !phone || !id) {
            tips('信息要填写完整');
            return;
        }
        $.ajax({
            type: 'post',
            url: '/user/update_connect_user',
            data: {
                username: name,
                company: company,
                email: email,
                phone: phone,
                id: id
            },
            dataType: 'json',
            success: function (res) {
                if (res['status'] == -1) {
                    tips(res['error']);
                }
                if (res['status'] == 1) {
                    $('.client[data-id="' + res['user']['id'] + '"]').find('.name').html(res['user']['username'])
                    $('.snail_module').find('.close').trigger('click');
                }
            },
            error: function () {

            }
        });
    });
    // 点击修改联系人按钮
    $('body').on('click', '.edit_contact', function () {
        var id = $(this).attr('data-id');
        if (id) {
            $.ajax({
                type: 'post',
                url: "/user/get_connect_user",
                data: {
                    id: id
                },
                dataType: 'json',
                success: function (data) {
                    if (data['status'] == -1) {
                        tips(data['error']);
                    }
                    if (data['status'] == 1) {
                        $('#update_name').val(data['user']['username']);
                        $('#update_phone').val(data['user']['phone']);
                        $('#update_email').val(data['user']['email']);
                        $('#update_company').val(data['user']['company']);
                        $('#update_user_id').val(id);
                        $('#update_module').attr('data-status', 'show');
                    }
                }
            });
        }
    });
    // 删除联系人
    $('body').on('click', '.del_contact', function () {
        var oThis = $(this), id = oThis.attr('data-id');
        if (id) {
            $.ajax({
                type: 'post',
                url: "/user/del_connect_user",
                data: {
                    id: id
                },
                dataType: 'json',
                success: function (data) {
                    if (data['status'] == -1) {
                        tips(data['error']);
                    }
                    if (data['status'] == 1) {
                        oThis.closest('.row_group').remove();
                    }
                }
            });
        }
    });
    // 拖动滑块
    $("#move_bar").slider({
        width: 340, // width
        height: 40, // height
        sliderBg: "rgb(134, 134, 131)", // 滑块背景颜色
        color: "#fff", // 文字颜色
        fontSize: 14, // 文字大小
        bgColor: "#33CC00", // 背景颜色
        textMsg: "按住滑块，拖拽验证", // 提示文字
        successMsg: "验证通过了哦", // 验证成功提示文字
        successColor: "#fff", // 滑块验证成功提示文字颜色
        time: 400, // 返回时间
        callback: function (result) { // 回调函数，true(成功),false(失败)
            if (result) {
                move_slider = true;
            }
        }
    });
    // 提交表单
    $("#submit_form").click(function () {
        var state = $('#protocol').is(':checked');
        if(!state){
            tips("承诺书未同意");
            return;
        }
        if(!move_slider){
            tips("请拖动滑块验证");
            return;
        }
        var existsMainConn = $('#exists_main_conn').val();
        if (existsMainConn == 1) {
        	addLiterature();
        } else {
            var username = $.trim($('#main_conn_name').val());
            var phone = $.trim($('#main_conn_phone').val());
            var email = $.trim($('#main_conn_email').val());
            var company = $.trim($('#main_conn_company').val());
            if (!username || !phone || !email || !company) {
                tips("请填写主要联系人信息");
                return;
            }
            $.ajax({
                type: 'post',
                url: "/user/add_connect_user",
                data: {
                    'username': username,
                    'phone': phone,
                    'email': email,
                    'company': company,
                    'is_main': 1
                },
                dataType: 'json',
                success: function (data) {
                    if (data['status'] == -1) {
                        tips(data['error']);
                    }
                    if (data['status'] == 1) {
                        addLiterature();
                    }
                }
            });
        }
    });
    //添加文献
    function addLiterature() {
        var docName = $.trim($('#doc_name').val()), docTitle = $.trim($('#doc_title').val()),
            docAuthor = $.trim($('#doc_author').val()), docTime = $.trim($('#doc_time').val()),
            docVol = $.trim($('#doc_vol').val()), docPage = $.trim($('#doc_page').val()),
            docNote = $.trim($('#doc_note').val());
		var random_code = $('#random_code').val();
        if ( !docTitle || !docAuthor ) {
            tips("请填写完整报告需求");
            return;
        }
        var reg = new RegExp("^[1-9][0-9]{3}$");
        if(docTime && !(reg.test(docTime))){
            tips("出版年请填写四位数字");
            return;
        }
        var reg = new RegExp("^[1-9][0-9]*$");
        if(docVol && !(reg.test(docVol))){
            tips("卷期请填写数字");
            return;
        }
        var reg = new RegExp("^[1-9]+-[1-9][0-9]*$");
        if(docPage && !(reg.test(docPage))){
            tips("起止页码请填写正确格式");
            return;
        }
        $.ajax({
            type: 'post',
            url: "/service/add_literature",
            data: {
                doc_name: docName,
                doc_title: docTitle,
                doc_author: docAuthor,
                doc_time: docTime,
                doc_vol: docVol,
                doc_page: docPage,
                doc_note: docNote,
				random_code:random_code
            },
            dataType: 'json',
            success: function (data) {
                if (data['status'] == -1) {
                    tips(data['error']);
                }
                if (data['status'] == 1) {
                    alert('您已经成功提交需求表单');
                    window.location.href = '/user/order_list?type=文献传递';
                }
            }
        });
    }
</script>